@model AttendanceManagementSystem.Api.Models.EmployeeListViewModel

@{
    ViewData["Title"] = "Список Сотрудников и Управление Табелями";
    var currentYear = DateTime.Now.Year;
    var currentMonth =DateTime.Now.Month;
}

<style>
    .card-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .action-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
   
</style>

<div class="card shadow-sm">
    <div class="card-header">
        <h3 class="card-title text-primary">Список активных сотрудников</h3>

        <div class="mt-3 card-header-actions">

            <a asp-controller="AdminAttendance" asp-action="Dashboard" class="btn btn-secondary shadow me-3">
                <i class="fas fa-arrow-left me-1"></i> Вернуться в панель управления
            </a>

            <div class="action-group">

               
                <form id="CreateCalendarForm"
                      asp-controller="AdminAttendance"
                      asp-action="SyncCalendarForAll"
                      asp-route-year="@currentYear"
                      asp-route-month="@currentMonth"
                      method="get"
                      class="d-inline">

                    <button type="button"
                            id="ShowCreateModal"
                            class="btn btn-success">
                        <i class="fas fa-calendar-plus me-1"></i> Синхронизация табеля (@currentYear-@currentMonth)
                    </button>
                </form>
             
            </div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>ФИО Сотрудника</th>
                <th style="width: 350px;">Действия</th> 
            </tr>
        </thead>
        <tbody>
            @foreach (var employee in Model.Employees)
            {
                <tr>
                    <td><strong>@employee.FullName</strong></td>
                    <td>
                        @{
                            var currentYearForLink = DateTime.Now.Year;
                            var currentMonthForLink = DateTime.Now.Month;
                        }

                        <div class="d-flex gap-2">

                            <a asp-controller="AdminAttendance"
                               asp-action="ViewCalendar"
                               asp-route-username="@employee.FullName"
                               asp-route-year="@currentYearForLink"
                               asp-route-month="@currentMonthForLink"
                               class="btn btn-info btn-sm text-white shadow-sm">
                                <i class="fas fa-eye me-1"></i> Табель
                            </a>

                            <a asp-controller="AdminAttendance"
                               asp-action="GetDetails"
                               asp-route-username="@employee.FullName"
                               asp-route-year="@currentYearForLink"
                               asp-route-month="@currentMonthForLink"
                               class="btn btn-secondary btn-sm shadow-sm">
                                <i class="fas fa-list me-1"></i> Все входы
                            </a>

                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>


<div class="modal fade" id="CreateConfirmationModal" tabindex="-1" aria-labelledby="CreateConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="CreateConfirmationModalLabel">
                    <i class="fas fa-magic me-2"></i> Умная обработка табеля
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4">
                <div class="d-flex align-items-center mb-4 p-3 bg-light rounded">
                    <div class="flex-shrink-0">
                        <i class="fas fa-brain text-primary fa-3x"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="fw-bold mb-1">Система выполнит следующие действия:</h6>
                        <ul class="text-muted small mb-0 ps-3">
                            <li>Если табель пуст — <strong>создаст календарь </strong> для всех активных сотрудников.</li>
                            <li>Если табель есть — <strong>заполнит время первого входа</strong> на основе загруженных логов.</li>
                        </ul>
                    </div>
                </div>
                
                <div class="px-2">
                    <p class="mb-2">Вы уверены, что хотите запустить <strong>синхронизацию</strong>?</p>
                    <p class="small text-secondary">
                        <i class="fas fa-info-circle text-info me-1"></i> 
                        Это действие обновит поле <b>"Первый вход"</b> и пересчитает минуты опоздания согласно актуальным данным.
                    </p>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" id="ConfirmCreateButton" class="btn btn-primary px-4 shadow-sm">
                    <span id="buttonText">Запустить процесс</span>
                    <span id="buttonSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
            $(document).ready(function () {

            const createModalElement = document.getElementById('CreateConfirmationModal');
            const updateModalElement = document.getElementById('UpdateConfirmationModal');


            $('#ShowCreateModal').on('click', function() {
                new bootstrap.Modal(createModalElement).show();
            });

            $('#ConfirmCreateButton').on('click', function() {
                bootstrap.Modal.getInstance(createModalElement).hide();
                $('#CreateCalendarForm').submit();
            });


            $('#ShowUpdateModal').on('click', function() {
                new bootstrap.Modal(updateModalElement).show();
            });

            $('#ConfirmUpdateButton').on('click', function() {
                bootstrap.Modal.getInstance(updateModalElement).hide();
                $('#UpdateCalendarForm').submit();
            });
        });
    </script>
}