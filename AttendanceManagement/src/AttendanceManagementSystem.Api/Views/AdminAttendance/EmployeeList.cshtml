@model AttendanceManagementSystem.Api.Models.EmployeeListViewModel

@{
    ViewData["Title"] = "Список Сотрудников и Управление Табелями";
    var currentYear = DateTime.Now.Year;
    var currentMonth = 11;
}

@* Kiritilgan Style qismini o'zgartirmadim *@
<style>
    .card-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .action-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    /* ... boshqa stillar ... */
</style>

<div class="card shadow-sm">
    <div class="card-header">
        <h3 class="card-title text-primary">Список активных сотрудников</h3>

        <div class="mt-3 card-header-actions">

            @* Qaytish Tugmasi *@
            <a asp-controller="AdminAttendance" asp-action="Dashboard" class="btn btn-secondary shadow me-3">
                <i class="fas fa-arrow-left me-1"></i> Вернуться в панель управления
            </a>

            <div class="action-group">

                @* **'Создать' tugmasi (ID orqali Modalni chaqiramiz) - Forma yashirin holatda qoladi*@
                <form id="CreateCalendarForm"
                      asp-controller="AdminAttendance"
                      asp-action="ViewCreateCalendarForAll"
                      asp-route-year="@currentYear"
                      asp-route-month="@currentMonth"
                      method="get"
                      class="d-inline">

                    <button type="button"
                            id="ShowCreateModal"
                            class="btn btn-success">
                        <i class="fas fa-calendar-plus me-1"></i> Создать Календарь (@currentYear-@currentMonth)
                    </button>
                </form>

                @* **'Обновить' tugmasi (ID orqali Modalni chaqiramiz) - Forma yashirin holatda qoladi *@
                <form id="UpdateCalendarForm"
                      asp-controller="AdminAttendance"
                      asp-action="ViewUpdateCalendarForAll"
                      asp-route-year="@currentYear"
                      asp-route-month="@currentMonth"
                      method="get"
                      class="d-inline">

                    <button type="button"
                            id="ShowUpdateModal"
                            class="btn btn-warning text-dark">
                        <i class="fas fa-sync-alt me-1"></i> Обновить Календарь (@currentYear-@currentMonth)
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@* ... Jadval qismi (o'zgartirishsiz) ... *@
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th>ФИО Сотрудника</th>
                <th style="width: 150px;">Табель</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var employee in Model.Employees)
            {
                <tr>
                    <td><strong>@employee.FullName</strong></td>
                    <td>
                        @{
                            var currentYearForLink = DateTime.Now.Year;
                            var currentMonthForLink = 11;
                        }
                        <a asp-controller="AdminAttendance"
                           asp-action="ViewCalendar"
                           asp-route-username="@employee.FullName"
                           asp-route-year="@currentYearForLink"
                           asp-route-month="@currentMonthForLink"
                           class="btn btn-info btn-sm">
                            <i class="fas fa-eye me-1"></i> Просмотр табеля
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* ========================================================= *@
@* 2. Ikkala Modal Strukturasini qo'shish *@
@* ========================================================= *@

<div class="modal fade" id="CreateConfirmationModal" tabindex="-1" aria-labelledby="CreateConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="CreateConfirmationModalLabel"><i class="fas fa-calendar-plus me-2"></i> Создание нового табеля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    <strong class="text-success">ВНИМАНИЕ!</strong>
                    <br>
                    Вы уверены, что хотите создать **Табель рабочего времени** для ВСЕХ активных сотрудников на текущий месяц?
                    <br><br>
                    <span class="text-danger">Это действие выполняется строго один раз в начале месяца.</span>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" id="ConfirmCreateButton" class="btn btn-success">Подтвердить создание</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="UpdateConfirmationModal" tabindex="-1" aria-labelledby="UpdateConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="UpdateConfirmationModalLabel"><i class="fas fa-sync-alt me-2"></i> Подтверждение Обновления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>
                    <strong class="text-warning">Подтвердите действие:</strong>
                    <br>
                    Это действие заполнит все незафиксированные записи о **ПЕРВОМ ВХОДЕ (времени прихода)** для ВСЕХ активных сотрудников за текущий месяц.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" id="ConfirmUpdateButton" class="btn btn-warning text-dark">Запустить обработку</button>
            </div>
        </div>
    </div>
</div>

@* ========================================================= *@
@* 3. Javascript Mantiqini qo'shish *@
@* ========================================================= *@

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
            $(document).ready(function () {

            // BS5 modalni to'g'ri boshqarish uchun
            const createModalElement = document.getElementById('CreateConfirmationModal');
            const updateModalElement = document.getElementById('UpdateConfirmationModal');

            // --- 1. 'Создать' tugmasi mantiqi ---

            $('#ShowCreateModal').on('click', function() {
                new bootstrap.Modal(createModalElement).show();
            });

            $('#ConfirmCreateButton').on('click', function() {
                // Modalni yopish
                bootstrap.Modal.getInstance(createModalElement).hide();
                // Forma yuborish
                $('#CreateCalendarForm').submit();
            });

            // --- 2. 'Обновить' tugmasi mantiqi ---

            $('#ShowUpdateModal').on('click', function() {
                new bootstrap.Modal(updateModalElement).show();
            });

            $('#ConfirmUpdateButton').on('click', function() {
                // Modalni yopish
                bootstrap.Modal.getInstance(updateModalElement).hide();
                // Forma yuborish
                $('#UpdateCalendarForm').submit();
            });
        });
    </script>
}