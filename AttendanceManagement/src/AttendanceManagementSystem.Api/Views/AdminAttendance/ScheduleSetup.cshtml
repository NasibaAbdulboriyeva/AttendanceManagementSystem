@model AttendanceManagementSystem.Api.Models.EmployeeScheduleViewModel
@using AttendanceManagementSystem.Domain.Entities

@{
    ViewData["Title"] = "Управление рабочими графиками";
}

<h2 class="mb-4 text-primary">🗓️ Управление рабочими графиками сотрудников</h2>
<p class="text-muted">Выберите сотрудников, настройте время и нажмите "Сохранить". Изменения коснутся только выбранных строк.</p>

@if (!string.IsNullOrEmpty(Model.Message))
{
    var alertClass = Model.Message.StartsWith("✅") ? "alert-success" : "alert-danger";
    <div class="alert @alertClass mt-3 alert-dismissible fade show" role="alert">
        @Model.Message
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="ScheduleSetup" method="post" id="scheduleForm">
    @Html.AntiForgeryToken()

    <div class="table-responsive">
        <table class="table table-bordered table-hover shadow-sm align-middle">
            <thead class="table-primary">
                <tr>
                    <th class="text-center" style="width: 50px;">
                        <div class="form-check d-flex justify-content-center">
                            <input type="checkbox" id="selectAll" class="form-check-input" style="cursor: pointer; width: 20px; height: 20px;" />
                        </div>
                    </th>
                    <th>ФИО Сотрудника</th>
                    <th style="width: 130px;">Начало Работы</th>
                    <th style="width: 130px;">Конец Работы</th>
                    <th style="width: 140px;">Лимит Опозданий (мин)</th>
                    <th style="width: 180px;">Тип Занятости</th>
                </tr>
            </thead>

            <tbody>
                @for (int i = 0; i < Model.Schedules.Count; i++)
                {
                    var rowClass = Model.Schedules[i].EmployeeScheduleId > 0 ? "table-light-success" : "table-light-warning";

                    <tr class="@rowClass schedule-row">
                        <td class="text-center">
                            <div class="form-check d-flex justify-content-center">
                                <input type="checkbox" asp-for="Schedules[i].IsSelected" class="form-check-input select-row" style="cursor: pointer; width: 18px; height: 18px;" />
                            </div>
                        </td>

                        <td>
                            <div class="d-flex align-items-center">
                                <strong class="text-dark me-2">@Model.Schedules[i].FullName</strong>
                                @if (Model.Schedules[i].EmployeeScheduleId == 0)
                                {
                                    <span class="badge bg-warning text-dark">New</span>
                                }
                            </div>

                            @* Hidden fields - ma'lumotlar yo'qolmasligi uchun *@
                            <input type="hidden" asp-for="Schedules[i].EmployeeId" />
                            <input type="hidden" asp-for="Schedules[i].EmployeeScheduleId" />
                            <input type="hidden" asp-for="Schedules[i].FullName" />
                        </td>

                        <td>
                            <input type="text" 
                                   id="startTime_@i" 
                                   class="form-control form-control-sm border-primary time-display" 
                                   placeholder="00:00" 
                                   maxlength="5"
                                   data-index="@i"
                                   data-field="StartTime" />
                            <input type="hidden" asp-for="Schedules[i].StartTime" class="time-hidden" />
                            <span asp-validation-for="Schedules[i].StartTime" class="text-danger small"></span>
                        </td>

                        <td>
                            <input type="text" 
                                   id="endTime_@i" 
                                   class="form-control form-control-sm border-primary time-display" 
                                   placeholder="00:00" 
                                   maxlength="5"
                                   data-index="@i"
                                   data-field="EndTime" />
                            <input type="hidden" asp-for="Schedules[i].EndTime" class="time-hidden" />
                            <span asp-validation-for="Schedules[i].EndTime" class="text-danger small"></span>
                        </td>

                        <td>
                            <input asp-for="Schedules[i].LimitInMinutes" type="number" min="0" max="500" class="form-control form-control-sm" />
                            <span asp-validation-for="Schedules[i].LimitInMinutes" class="text-danger small"></span>
                        </td>

                        <td>
                            <select asp-for="Schedules[i].EmployementType"
                                    asp-items="Html.GetEnumSelectList<EmployementType>()"
                                    class="form-select form-select-sm">
                            </select>
                            <span asp-validation-for="Schedules[i].EmployementType" class="text-danger small"></span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-4 d-flex justify-content-between align-items-center">
        <a asp-controller="AdminAttendance" asp-action="Dashboard" class="btn btn-outline-secondary btn-lg shadow-sm">
            <i class="fas fa-arrow-left me-2"></i> Вернуться назад
        </a>

        <div class="text-end">
            <span id="selectedCounter" class="me-3 text-muted fw-bold">Выбрано: 0</span>
            <button type="submit" class="btn btn-primary btn-lg shadow px-5">
                <i class="fas fa-save me-2"></i> Сохранить выбранные (@Model.Schedules.Count)
            </button>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            // Vaqtni 24 soatlik formatga o'girish
            function convertTo24Hour(timeStr) {
                if (!timeStr) return '';
                
                // Agar allaqachon HH:MM formatida bo'lsa
                if (/^\d{2}:\d{2}$/.test(timeStr)) {
                    return timeStr;
                }
                
                // AM/PM formatidan 24 soatga o'girish
                const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    const minutes = match[2];
                    const period = match[3].toUpperCase();
                    
                    if (period === 'PM' && hours !== 12) {
                        hours += 12;
                    } else if (period === 'AM' && hours === 12) {
                        hours = 0;
                    }
                    
                    return String(hours).padStart(2, '0') + ':' + minutes;
                }
                
                return timeStr;
            }

            // Sahifa yuklanganda barcha vaqtlarni 24 soatlikga o'girish
            $('.time-display').each(function() {
                const index = $(this).data('index');
                const field = $(this).data('field');
                const hiddenInput = $(this).closest('td').find('.time-hidden');
                const originalValue = hiddenInput.val();
                
                const time24 = convertTo24Hour(originalValue);
                $(this).val(time24);
            });

            // Vaqt kiritish validatsiyasi
            $('.time-display').on('input', function() {
                let val = $(this).val().replace(/[^0-9:]/g, '');
                
                // Avtomatik ":" qo'shish
                if (val.length === 2 && val.indexOf(':') === -1) {
                    val += ':';
                }
                
                $(this).val(val);
                
                // Hidden inputga yozish
                const hiddenInput = $(this).closest('td').find('.time-hidden');
                hiddenInput.val(val);
                
                // Validatsiya
                if (val.length === 5) {
                    const parts = val.split(':');
                    const hours = parseInt(parts[0]);
                    const minutes = parseInt(parts[1]);
                    
                    if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                        $(this).addClass('is-invalid');
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                }
            });

            // Form yuborilishidan oldin
            $('#scheduleForm').on('submit', function() {
                $('.time-display').each(function() {
                    const hiddenInput = $(this).closest('td').find('.time-hidden');
                    hiddenInput.val($(this).val());
                });
            });

            // Tanlanganlar sonini yangilash funksiyasi
            function updateCounter() {
                const count = $('.select-row:checked').length;
                $('#selectedCounter').text('Выбрано: ' + count);

                const submitBtn = $('button[type="submit"]');
                if(count === 0) {
                    submitBtn.addClass('disabled').attr('title', 'Выберите хотя бы одну строку');
                } else {
                    submitBtn.removeClass('disabled').removeAttr('title');
                }
            }

            // "Select All" bosilganda
            $('#selectAll').on('change', function () {
                const isChecked = $(this).prop('checked');
                $('.select-row').prop('checked', isChecked);

                if(isChecked) {
                    $('.schedule-row').addClass('border-primary shadow-sm');
                } else {
                    $('.schedule-row').removeClass('border-primary shadow-sm');
                }
                updateCounter();
            });

            // Alohida qator checkboxi bosilganda
            $('.select-row').on('change', function () {
                if (!$(this).prop('checked')) {
                    $('#selectAll').prop('checked', false);
                    $(this).closest('tr').removeClass('border-primary shadow-sm');
                } else {
                    $(this).closest('tr').addClass('border-primary shadow-sm');
                }

                if ($('.select-row:checked').length === $('.select-row').length) {
                    $('#selectAll').prop('checked', true);
                }
                updateCounter();
            });

            updateCounter();
        });
    </script>

    <style>
        .table-light-success {
            background-color: #e8f5e9 !important;
        }

        .table-light-warning {
            background-color: #fffde7 !important;
        }

        .schedule-row {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

            .schedule-row.border-primary {
                border-left: 4px solid #0d6efd !important;
                background-color: #f0f7ff !important;
            }

        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 2px;
            text-align: center;
        }

        .time-display.is-invalid {
            border-color: #dc3545 !important;
            background-color: #ffe6e6;
        }
    </style>
}