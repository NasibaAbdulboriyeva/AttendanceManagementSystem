@model AttendanceManagementSystem.Api.Models.AttendanceCalendarViewModel

@{
    ViewData["Title"] = "Xodim Qatnashish Kalendari";
    var currentMonth = Model.TargetMonth.ToString("MMMM yyyy");

    // TimeOnly? turini formatlash uchun yordamchi funksiya
    // DTO ichidagi TimeOnly turini formatlash
    string FormatTime(TimeOnly time) => time.ToString("HH:mm");
}

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h2 class="m-0 font-weight-bold text-primary">
            @Model.EmployeeFullName xodimi uchun kalendar
        </h2>
        <p class="text-muted">Oy: @currentMonth</p>
    </div>
    <div class="card-body">

        @* --- Oylik Hisobot (ViewModel orqali) --- *@
        <div class="alert alert-info">
            <p><strong>Umumiy Kech Qolish (oy davomida):</strong> @Model.MonthlyLogs.Sum(l => l.LateMinutesTotal) daqiqa</p>
            @{
                // Oylik limitni hisoblash uchun DTO'dagi Total va Remaining maydonlarini ishlatamiz
                var totalLate = Model.MonthlyLogs.Sum(l => l.LateMinutesTotal);
                var remainingLate = 80 - totalLate; // 80 minut limitni taxmin qildik
            }
            <p>
                <strong>Qolgan Kech Qolish Limiti (80 min):</strong>
                @if (remainingLate < 0)
                {
                    <span class="text-danger">Limitdan oshgan! (@(Math.Abs(remainingLate)) daqiqa)</span>
                }
                else
                {
                    <span class="text-success">@remainingLate daqiqa qoldi</span>
                }
            </p>
        </div>
        @* ---------------------------------------- *@

        <table class="table table-bordered table-responsive table-sm">
            <thead>
                <tr>
                    <th style="width: 100px;">Sana</th>
                    <th style="width: 120px;">Rasmiy Kirish</th>
                    <th style="width: 120px;">Amaldagi Kirish</th>
                    <th style="width: 120px;">Ketish Vaqti</th>
                    <th style="width: 100px;">Kech Qolish (Min)</th>
                    <th style="width: 120px;">Ishlangan (Soat)</th> @* DTO da WorkedHours bor *@
                    <th style="width: 100px;">Status</th>
                    <th style="width: 100px;">Sababli</th>
                    <th style="width: 150px;">Izoh</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var dayLog in Model.MonthlyLogs)
                {
                    // Kunlik kech qolish minutlari uchun DTO dagi LateMinutesTotal ni ishlatamiz
                    var isLate = dayLog.LateMinutesTotal > 0;
                    var rowClass = isLate ? "table-danger" : "";

                    <tr class="@rowClass" id="log-@dayLog.EntryDay.ToString("yyyyMMdd")">
                        <td>@dayLog.EntryDay.ToString("dd.MM")</td>

                        @* ScheduledStartTime TimeSpan turida berilgan, uni to'g'irlash kerak *@
                        <td>@(dayLog.ScheduledStartTime != TimeSpan.Zero ? dayLog.ScheduledStartTime.ToString(@"hh\:mm") : "—")</td>

                        @* TimeOnly lar uchun: *@
                        <td>@FormatTime(dayLog.FirstEntryTime)</td>
                        <td>@FormatTime(dayLog.LastLeavingTime)</td>

                        @* Kech qolish minutlari *@
                        <td>
                            @if (isLate)
                            {
                                <span class="badge badge-danger">@dayLog.LateMinutesTotal</span>
                            }
                            else
                            {
                                <span>—</span>
                            }
                        </td>

                        @* Ishlangan soatlar *@
                        <td>@dayLog.WorkedHours</td>

                        @* Status *
                    <td>
                    @if (isLate)
                    {
                    <span class="badge badge-danger">Kech qolgan</span>
                    }
                    else if (dayLog.FirstEntryTime != default) // Agar TimeOnly kiritilgan bo'lsa
                    {
                    <span class="badge badge-success">Kelgan</span>
                    }
                    else
                    {
                    <span class="badge badge-secondary">Yo'q</span>
                    }
                    </td>

                    @* Sababli (Interaktiv Checkbox) *@
                        <td class="text-center">
                            @if (isLate)
                            {
                                <input type="checkbox"
                                       data-employee-id="@dayLog.EmployeeId"
                                       data-entry-day="@dayLog.EntryDay.ToString("yyyy-MM-dd")"
                                       checked="@dayLog.IsJustified"
                                       class="justify-checkbox" />
                            }
                            else
                            {
                                <span>—</span>
                            }
                        </td>

                        <td>@dayLog.Description</td>
                    </tr>
                }
            </tbody>
        </table>

        <a asp-action="EmployeeList" asp-controller="AdminAttendance" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Ro'yxatga Qaytish
        </a>
    </div>
</div>

@section Scripts {
    <script>
        // ... (Oldingi javobdagi AJAX mantiqni shu yerga joylashtiring) ...
        // Checkbox holati o'zgarishini kuzatish uchun mantiq shu yerda bo'lishi kerak.
    </script>
}