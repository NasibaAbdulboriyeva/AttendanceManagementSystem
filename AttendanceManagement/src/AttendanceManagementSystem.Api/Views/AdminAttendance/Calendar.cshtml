@model AttendanceManagementSystem.Api.Models.AttendanceCalendarViewModel

@{
    ViewData["Title"] = "Monthly Calendar";
    var currentMonth = Model.TargetMonth.ToString("MMMM yyyy");

    
    string FormatTime(TimeOnly time) => time.ToString("HH:mm");
}

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h2 class="m-0 font-weight-bold text-primary">
            Календарь для сотрудника @Model.EmployeeFullName
        </h2>
        <p class="text-muted">Месяц: @currentMonth</p>
    </div>
    <div class="card-body">

        @* --- Oylik Hisobot (ViewModel orqali) --- *@
        <div class="alert alert-info">
            <p><strong>Общее опоздание (за месяц):</strong> @Model.MonthlyLogs.Sum(l => l.LateMinutesTotal) минут</p>
            @{
                // Oylik limitni hisoblash uchun DTO'dagi Total va Remaining maydonlarini ishlatamiz
                var totalLate = Model.MonthlyLogs.Sum(l => l.LateMinutesTotal);
                var remainingLate = 80 - totalLate; 
            }
            <p>
                <strong>Остаток лимита (80 min):</strong>
                @if (remainingLate < 0)
                {
                    <span class="text-danger">Лимит истек !(@(Math.Abs(remainingLate)) минут)</span>
                }
                else
                {
                    <span class="text-success">
                        <strong>осталось @remainingLate минут</strong>
                    </span>
                }
            </p>
        </div>

        <table class="table table-bordered table-responsive table-sm">
            <thead>
                <tr>
                    <th style="width: 100px;">Дата</th>
                    <th style="width: 120px;">Время прихода</th>
                    <th style="width: 120px;">Приходил(а)</th>
                    <th style="width: 100px;">Опоздание (мин/в день)</th>
                    <th style="width: 100px;">Обосновано</th>
                    <th style="width: 150px;">Причина/комментария</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var dayLog in Model.MonthlyLogs)
                {
                    // Kunlik kech qolish minutlari uchun DTO dagi LateMinutesTotal ni ishlatamiz
                    var isLate = dayLog.LateMinutesTotal > 0;
                    var rowClass = isLate ? "table-danger" : "";

                    <tr class="@rowClass" id="log-@dayLog.EntryDay.ToString("yyyyMMdd")">
                        <td>@dayLog.EntryDay.ToString("dd.MM")</td>

                        @* ScheduledStartTime TimeSpan turida berilgan, uni to'g'irlash kerak *@
                        <td>@(dayLog.ScheduledStartTime != TimeSpan.Zero ? dayLog.ScheduledStartTime.ToString(@"hh\:mm") : "—")</td>

                        @* TimeOnly lar uchun: *@
                        <td>@FormatTime(dayLog.FirstEntryTime)</td>

                        @* Kech qolish minutlari *@
                        <td>
                            @if (isLate)
                            {
                                <span class="badge badge-danger">@dayLog.LateMinutesTotal</span>
                            }
                            else
                            {
                                <span>—</span>
                            }
                        </td>

                     

                        @* Status *
                    <td>
                    @if (isLate)
                    {
                    <span class="badge badge-danger">Kech qolgan</span>
                    }
                    else if (dayLog.FirstEntryTime != default) // Agar TimeOnly kiritilgan bo'lsa
                    {
                    <span class="badge badge-success">Kelgan</span>
                    }
                    else
                    {
                    <span class="badge badge-secondary">Yo'q</span>
                    }
                    </td>

                    @* Sababli (Interaktiv Checkbox) *@
                        <td class="text-center">
                            @if (isLate)
                            {
                                <input type="checkbox"
                                       data-employee-id="@dayLog.EmployeeId"
                                       data-entry-day="@dayLog.EntryDay.ToString("yyyy-MM-dd")"
                                       checked="@dayLog.IsJustified"
                                       class="justify-checkbox" />
                            }
                            else
                            {
                                <span>—</span>
                            }
                        </td>

                        <td>
                            <input type="text"
                                                     data-employee-id="@dayLog.EmployeeId"
                                                     data-entry-day="@dayLog.EntryDay.ToString("yyyy-MM-dd")"
                                                     value="@dayLog.Description"
                                                     class="form-control form-control-sm comment-input"
                                                     placeholder="Укажите причину ..."
                                                     style="width: 240px;" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <a asp-action="EmployeeList" asp-controller="AdminAttendance" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Вернуться к листу
        </a>
    </div>
</div>

@section Scripts {
    <script>
        // ... (Oldingi javobdagi AJAX mantiqni shu yerga joylashtiring) ...
        // Checkbox holati o'zgarishini kuzatish uchun mantiq shu yerda bo'lishi kerak.
    </script>
}