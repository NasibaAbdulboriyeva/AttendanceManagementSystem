@model AttendanceManagementSystem.Api.Models.AttendanceCalendarViewModel
@{
    ViewData["Title"] = "Monthly Calendar";
    var currentMonth = Model.TargetMonth.ToString("MMMM yyyy");

    string FormatTime(TimeOnly time) => time.ToString("HH:mm");
}

<!-- Error Modal (Pop-up) -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title fw-bold" id="errorModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i> Внимание!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning border-start border-5 border-warning mb-3">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-info-circle me-2"></i> Проблема с расписанием
                    </h6>
                    <p class="mb-0" id="errorMessageText">@TempData["ErrorMessage"]</p>
                </div>

                @if (ViewBag.MissingEmployees != null)
                {
                    <div class="card border-warning mb-3">
                        <div class="card-header bg-warning bg-opacity-10 border-warning">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="fas fa-users me-2"></i> Сотрудники без графика:
                            </h6>
                        </div>
                        <div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">
                            <ul class="list-group list-group-flush">
                                @foreach (var empName in (IEnumerable<string>)ViewBag.MissingEmployees)
                                {
                                    <li class="list-group-item d-flex align-items-center py-2">
                                        <i class="fas fa-user-clock text-warning me-2"></i>
                                        <span class="fw-medium">@empName</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                }

                <div class="alert alert-info mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    <small>Пожалуйста, настройте рабочее время для указанных сотрудников перед созданием календаря.</small>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Закрыть
                </button>
                <a asp-action="ScheduleSetup" class="btn btn-warning">
                    <i class="fas fa-calendar-alt me-1"></i> Перейти к настройке графиков
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Daily Logs Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="logDetailsModalLabel border-0">
                    <i class="fas fa-clock me-2"></i> Детали посещений
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="modal-loading" class="text-center my-4" style="display:none;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Загрузка данных...</p>
                </div>
                <div id="modal-content-area">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h2 class="m-0 font-weight-bold text-primary">
            Календарь для сотрудника @Model.EmployeeFullName
        </h2>
        <p class="text-muted">Месяц: @currentMonth</p>
    </div>
    <div class="card-body">

        @{
            var unjustifiedLate = Model.MonthlyLogs
            .Where(l => l.LateMinutesTotal > 0 && l.IsJustified == false)
            .Sum(l => l.LateMinutesTotal);

            var totalUnjustifiedLate = unjustifiedLate;
            var remainingLate = Model.TotalUnjustifiedLates;
        }
        <div class="alert alert-info">
            <p>
                <strong>Общее опоздание (за месяц, без оправдания):</strong>
                <span id="monthly-total-late">@totalUnjustifiedLate</span> минут
            </p>
            <p>
                <strong>Остаток лимита (@Model.DefaultLimit min):</strong>
                @if (remainingLate < 0)
                {
                    <span class="text-danger font-weight-bold" id="monthly-remaining-late-status">
                        Лимит истек! (@(Math.Abs(remainingLate)) минут перерасхода)
                    </span>
                }
                else
                {
                    <span class="text-success font-weight-bold" id="monthly-remaining-late-status">
                        осталось @remainingLate минут
                    </span>
                }
            </p>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th style="width: 40px;">Дата</th>
                        <th style="width: 80px;">Рабочий день</th>
                        <th style="width: 90px;">План. время</th>
                        <th style="width: 100px;">Факт. приход (Ручной ввод)</th>
                        <th style="width: 40px;">Опоздание (мин)</th>
                        <th style="width: 100px;">Предупредил(а)</th>
                        <th style="width: 120px;">Причина/комментарий</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var dayLog in Model.MonthlyLogs)
                    {
                        var isLate = dayLog.LateMinutesTotal > 0;
                        var rowClass = isLate && !dayLog.IsJustified ? "table-danger" : "";

                        var dayOfWeek = dayLog.EntryDay.DayOfWeek;
                        var isWeekend = (dayOfWeek == DayOfWeek.Saturday || dayOfWeek == DayOfWeek.Sunday);

                        <tr class="@rowClass"
                            id="log-@dayLog.EntryDay.ToString("yyyyMMdd")"
                            data-late-minutes="@dayLog.LateMinutesTotal"
                            data-is-justified="@dayLog.IsJustified.ToString().ToLower()"
                            data-is-working-day="@dayLog.IsWorkingDay.ToString().ToLower()">

                            <td class="text-center font-weight-bold">
                                <a href="javascript:void(0)"
                                   class="view-daily-logs text-primary text-decoration-none"
                                   data-employee-id="@dayLog.EmployeeId"
                                   data-date="@dayLog.EntryDay.ToString("yyyy-MM-dd")">
                                    @dayLog.EntryDay.ToString("dd.MM")
                                </a>
                            </td>

                            <td class="text-center working-day-cell">
                                <div class="form-check form-switch d-flex align-items-center justify-content-center">
                                    <input type="checkbox"
                                           data-employee-id="@dayLog.EmployeeId"
                                           data-entry-day="@dayLog.EntryDay.ToString("yyyy-MM-dd")"
                                           checked="@dayLog.IsWorkingDay"
                                           class="form-check-input working-day-checkbox"
                                           role="switch"
                                           id="work-day-@dayLog.EntryDay.ToString("yyyyMMdd")" />

                                    <label class="form-check-label working-day-visual-icon ml-2 @(dayLog.IsWorkingDay ? "text-primary" : "text-muted") font-weight-bold"
                                           for="work-day-@dayLog.EntryDay.ToString("yyyyMMdd")">
                                        @(dayLog.IsWorkingDay ? " .ON" : " .OFF")
                                    </label>
                                </div>
                            </td>

                            <td>@(dayLog.ScheduledStartTime != TimeOnly.MinValue ? dayLog.ScheduledStartTime.ToString(@"HH\:mm") : "—")</td>

                            <td>
                                @{
                                    var entryTimeString = dayLog.FirstEntryTime != default ? FormatTime(dayLog.FirstEntryTime) : "";
                                }
                                <input type="time"
                                       data-employee-id="@dayLog.EmployeeId"
                                       data-entry-day="@dayLog.EntryDay.ToString("yyyy-MM-dd")"
                                       value="@entryTimeString"
                                       class="form-control form-control-sm manual-entry-time" />
                            </td>
                            <td class="late-minutes-cell text-center">
                                @if (isLate)
                                {
                                    <span class="badge badge-warning text-dark current-late-minutes">@dayLog.LateMinutesTotal</span>
                                }
                                else
                                {
                                    <span class="current-late-minutes">0</span>
                                }
                            </td>

                            <td class="text-center justify-status-cell">
                                @if (dayLog.IsWorkingDay)
                                {
                                    <div class="d-flex align-items-center justify-content-center">
                                        <input type="checkbox"
                                               data-employee-id="@dayLog.EmployeeId"
                                               data-entry-day="@dayLog.EntryDay.ToString("yyyy-MM-dd")"
                                               checked="@dayLog.IsJustified"
                                               class="justify-checkbox mr-2"
                                               style="transform: scale(1.5);" />

                                        <span class="justify-visual-icon @(dayLog.IsJustified ? "text-success" : "text-secondary") font-weight-bold">
                                            @(dayLog.IsJustified ? "_✅" : "_❌")
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <span>—</span>
                                }
                            </td>

                            <td>
                                <input type="text"
                                       data-employee-id="@dayLog.EmployeeId"
                                       data-entry-day="@dayLog.EntryDay.ToString("yyyy-MM-dd")"
                                       value="@dayLog.Description"
                                       class="form-control form-control-sm comment-input"
                                       placeholder="Укажите причину ..." />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <a asp-action="EmployeeList" asp-controller="AdminAttendance" class="btn btn-secondary mt-3">
            <i class="fas fa-arrow-left"></i> Вернуться к листу
        </a>
    </div>
</div>

<div class="mt-4 d-flex justify-content-between">
    <a asp-controller="AdminAttendance" asp-action="Dashboard" class="btn btn-secondary btn-lg shadow">
        <i class="fas fa-arrow-left me-1"></i> Вернуться в панель управления
    </a>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Show error modal if error message exists
        @if (TempData["ErrorMessage"] != null)
        {
            <text>
                    var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    errorModal.show();
            </text>
        }

            function showFeedback(element, isSuccess) {
                element.removeClass('is-valid is-invalid');
                if (isSuccess) {
                    element.addClass('is-valid');
                } else {
                    element.addClass('is-invalid');
                }
                setTimeout(function () {
                    element.removeClass('is-valid is-invalid');
                }, 1500);
            }

            function updateMonthlySummary() {
                let totalUnjustifiedLate = 0;

                $('tbody tr').each(function () {
                    const row = $(this);
                    const lateMinutes = parseInt(row.data('late-minutes') || 0);
                    const isJustified = row.data('is-justified') === 'true';

                    if (lateMinutes > 0 && !isJustified) {
                        totalUnjustifiedLate += lateMinutes;
                    }
                });

                const remainingLate = @Model.DefaultLimit - totalUnjustifiedLate;
                const statusSpan = $('#monthly-remaining-late-status');
                const totalLateSpan = $('#monthly-total-late');

                totalLateSpan.text(totalUnjustifiedLate);

                statusSpan.removeClass('text-success text-danger');
                if (remainingLate < 0) {
                    statusSpan.addClass('text-danger');
                    statusSpan.html(`Лимит истек! (${Math.abs(remainingLate)} минут перерасхода)`);
                } else {
                    statusSpan.addClass('text-success');
                    statusSpan.html(`осталось ${remainingLate} минут`);
                }
            }

            $('.working-day-checkbox').on('change', function () {
                var checkbox = $(this);
                var row = checkbox.closest('tr');
                var isChecked = checkbox.is(':checked');
                var employeeId = checkbox.data('employee-id');
                var entryDay = checkbox.data('entry-day');

                if (!confirm('Вы уверены, что изменить статус рабочего дня?')) {
                    checkbox.prop('checked', !isChecked);
                    return;
                }

                const visualIcon = row.find('.working-day-visual-icon');
                visualIcon.removeClass('text-success text-secondary');
                if (isChecked) {
                    visualIcon.addClass('text-primary').text('   .ON');
                } else {
                    visualIcon.addClass('text-muted').text('   .OFF');
                }

                $.ajax({
                    url: '@Url.Action("UpdateWorkingDayStatus", "AdminAttendance")',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    data: JSON.stringify({
                        EmployeeId: employeeId,
                        EntryDay: entryDay,
                        IsWorkingDay: isChecked
                    }),
                    success: function (response) {
                        showFeedback(checkbox, true);
                        row.data('is-working-day', isChecked.toString().toLowerCase());

                        const lateMinutes = parseInt(row.data('late-minutes') || 0);
                        if (lateMinutes > 0) {
                            if (isChecked) {
                                row.removeClass('table-danger');
                            } else {
                                row.addClass('table-danger');
                            }
                        }

                        updateMonthlySummary();
                    },
                    error: function () {
                        showFeedback(checkbox, false);
                        alert("Ошибка: Статус не изменен.");
                        checkbox.prop('checked', !isChecked);
                    }
                });
            });

            $('.justify-checkbox').on('change', function () {
                var checkbox = $(this);
                var row = checkbox.closest('tr');
                var isChecked = checkbox.is(':checked');
                var employeeId = checkbox.data('employee-id');
                var entryDay = checkbox.data('entry-day');

                if (!confirm('Вы уверены, что хотите изменить статус оправдания?')) {
                    checkbox.prop('checked', !isChecked);
                    return;
                }

                const visualIcon = row.find('.justify-visual-icon');
                visualIcon.removeClass('text-success text-secondary');
                if (isChecked) {
                    visualIcon.addClass('text-success').text('_✅');
                } else {
                    visualIcon.addClass('text-secondary').text('_❌');
                }

                $.ajax({
                    url: '@Url.Action("UpdateJustificationStatus", "AdminAttendance")',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    data: JSON.stringify({
                        EmployeeId: employeeId,
                        EntryDay: entryDay,
                        IsJustified: isChecked
                    }),
                    success: function (response) {
                        showFeedback(checkbox, true);
                        row.data('is-justified', isChecked.toString().toLowerCase());

                        const lateMinutes = parseInt(row.data('late-minutes') || 0);
                        if (lateMinutes > 0) {
                            if (isChecked) {
                                row.removeClass('table-danger');
                            } else {
                                row.addClass('table-danger');
                            }
                        }

                        updateMonthlySummary();
                    },
                    error: function () {
                        showFeedback(checkbox, false);
                        alert("Ошибка: Статус оправдания не сохранен.");
                        checkbox.prop('checked', !isChecked);
                    }
                });
            });

            $('.comment-input').on('blur', function () {
                var input = $(this);
                var employeeId = input.data('employee-id');
                var entryDay = input.data('entry-day');
                var description = input.val();

                if (description === input.data('original-value')) {
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdateDescription", "AdminAttendance")',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    data: JSON.stringify({
                        EmployeeId: employeeId,
                        EntryDay: entryDay,
                        Description: description
                    }),
                    beforeSend: function () {
                        input.data('original-value', input.val());
                    },
                    success: function (response) {
                        showFeedback(input, true);
                    },
                    error: function (xhr, status, error) {
                        showFeedback(input, false);
                        console.error("Ошибка сохранения комментария:", error);
                    }
                });
            });

            $('.manual-entry-time').on('blur', function () {
                var input = $(this);
                var manualEntryTime = input.val();
                var employeeId = input.data('employee-id');
                var entryDay = input.data('entry-day');
                var row = input.closest('tr');

                if (manualEntryTime === input.data('original-value')) {
                    return;
                }

                if (!confirm('Вы действительно хотите сохранить это время?')) {
                    input.val(input.data('original-value'));
                    return;
                }

                const manualTimeToSend = manualEntryTime === "" ? "00:00:00" : manualEntryTime + ":00";

                $.ajax({
                    url: '@Url.Action("UpdateEntryTime", "AdminAttendance")',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    data: JSON.stringify({
                        EmployeeId: employeeId,
                        EntryDay: entryDay,
                        ManualEntryTime: manualTimeToSend
                    }),
                    success: function (response) {
                        showFeedback(input, true);
                        input.data('original-value', manualEntryTime);

                        if (response.success && response.lateMinutes !== undefined) {
                            const newLateMinutes = response.lateMinutes;
                            const lateMinutesSpan = row.find('.late-minutes-cell .current-late-minutes');

                            lateMinutesSpan.removeClass('badge badge-warning').text('—');
                            if (newLateMinutes > 0) {
                                lateMinutesSpan.addClass('badge badge-warning').text(newLateMinutes);
                            }

                            row.data('late-minutes', newLateMinutes);

                            const isJustified = row.data('is-justified') === 'true';

                            if (newLateMinutes > 0 && !isJustified) {
                                row.addClass('table-danger');
                            } else {
                                row.removeClass('table-danger');
                            }

                            updateMonthlySummary();
                        } else {
                            console.warn("Неполные данные от сервера.");
                        }
                    },
                    error: function (xhr, status, error) {
                        showFeedback(input, false);
                        alert("Ошибка: Время не сохранено.");
                        input.val(input.data('original-value'));
                    }
                });
            });

            $('.manual-entry-time').each(function () {
                $(this).data('original-value', $(this).val());
            });

            $('.comment-input').each(function () {
                $(this).data('original-value', $(this).val());
            });

            updateMonthlySummary();
        });

        $('.view-daily-logs').on('click', function () {
            const employeeId = $(this).data('employee-id');
            const date = $(this).data('date');
            const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));

            $('#modal-content-area').html('');
            $('#modal-loading').show();
            modal.show();

            $.ajax({
                url: '/AdminAttendance/GetDailyRawLogs',
                type: 'GET',
                data: { employeeId: employeeId, date: date },
                success: function (data) {
                    $('#modal-loading').hide();

                    let html = `
                        <div class="p-3 bg-light border-bottom">
                            <strong>Дата:</strong> ${date}
                        </div>
                        <table class="table table-hover mb-0">
                            <thead class="table-light small uppercase">
                                <tr>
                                    <th class="ps-3">Время записи</th>
                                    <th>Тип</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    if (data.length === 0) {
                        html += `<tr><td colspan="2" class="text-center py-4 text-muted">Записи не найдены</td></tr>`;
                    } else {
                        data.forEach(log => {
                            html += `
                                <tr>
                                    <td class="ps-3 fw-bold text-dark">${log.recordedTime}</td>
                                    <td><span class="badge bg-info">Check</span></td>
                                </tr>`;
                        });
                    }

                    html += `</tbody></table>`;
                    $('#modal-content-area').html(html);
                },
                error: function () {
                    $('#modal-loading').hide();
                    $('#modal-content-area').html('<div class="alert alert-danger m-3">Ошибка при загрузке данных</div>');
                }
            });
        });
    </script>
}
